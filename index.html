"""
transcribe_gifts.py

Author: Rosary-mom (Generated by AI Assistant)
Context: Simulation of Charismata Repository
Description: 
    Scrapes the 7 Gifts of the Holy Spirit from rosaryparish.com
    and formats them as game data (JSON) for the Simulation engine.
    
    Adheres to 'former Gamifications' logic by treating spiritual 
    definitions as attribute descriptions.

Dependencies:
    pip install requests beautifulsoup4
"""

import requests
from bs4 import BeautifulSoup
import json
import re

# Target Configuration
SOURCE_URL = "https://www.rosaryparish.com/7-geistesgaben"
OUTPUT_FILE = "charismata_data.json"

# The 7 Gifts (German) used as anchor points for scraping
# We look for these keywords to identify the relevant sections.
GIFT_KEYWORDS = [
    "Weisheit", 
    "Einsicht", 
    "Rat", 
    "Stärke", 
    "Erkenntnis", 
    "Frömmigkeit", 
    "Gottesfurcht"
]

def fetch_and_parse_gifts(url):
    """
    Fetches the HTML content and extracts definitions for the 7 gifts.
    """
    print(f"[*] Connecting to {url}...")
    try:
        response = requests.get(url, timeout=10)
        response.raise_for_status()
    except requests.RequestException as e:
        print(f"[!] Error fetching data: {e}")
        return []

    soup = BeautifulSoup(response.content, 'html.parser')
    
    extracted_gifts = []
    
    # Heuristic: The blog likely uses headers (H2/H3/Strong) for the Gift Names 
    # followed by Paragraphs (P) for the descriptions.
    
    # We iterate through all potential header elements
    content_area = soup.find('body') # Can be narrowed down if div class is known
    
    for keyword in GIFT_KEYWORDS:
        # Find the element containing the keyword
        # Note: This is a flexible search; it looks for the keyword in bold or headers
        header_found = content_area.find(lambda tag: tag.name in ['h2', 'h3', 'strong', 'b'] and keyword in tag.get_text())
        
        description = "Description unavailable."
        
        if header_found:
            # Helper to find the next meaningful text block
            curr_element = header_found.parent if header_found.name in ['strong', 'b'] else header_found
            
            # Look ahead for the next paragraph
            next_p = curr_element.find_next_sibling('p')
            if next_p:
                description = next_p.get_text(strip=True)
            else:
                # Fallback: Sometimes text is directly after the bold tag
                description = header_found.next_sibling
                if description:
                    description = str(description).strip()

        # Gamification Structure
        gift_obj = {
            "id": keyword.lower().replace("ü", "ue").replace("ö", "oe").replace("ä", "ae"),
            "name_de": keyword,
            "source_text": description,
            # Placeholder stats for the Simulation engine
            "stats": {
                "mana_cost": 0,
                "grace_bonus": 10,
                "category": "Passive"
            }
        }
        extracted_gifts.append(gift_obj)
        print(f"    [+] Transcribed: {keyword}")

    return extracted_gifts

def save_to_json(data, filename):
    """Saves the transcribed data to a JSON file for the game engine."""
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(data, f, indent=4, ensure_ascii=False)
    print(f"[*] Data saved to {filename}")

# --- Simulation Class (Gamification Logic) ---
class CharismaSimulation:
    """
    Mock class representing how this data is used in the 'Rosary-mom' engine.
    """
    def __init__(self, data_file):
        with open(data_file, 'r', encoding='utf-8') as f:
            self.charismata = json.load(f)
        print("\n[*] Simulation Loaded. Available Charismata:")

    def display_charismata(self):
        for gift in self.charismata:
            print(f" - {gift['name_de']}: {gift['source_text'][:60]}...")

if __name__ == "__main__":
    print("--- Transcribing Blog Entry for Simulation of Charismata ---")
    
    # 1. Transcribe
    gifts_data = fetch_and_parse_gifts(SOURCE_URL)
    
    # 2. Save
    if gifts_data:
        save_to_json(gifts_data, OUTPUT_FILE)
        
        # 3. Simulate (Verify format)
        sim = CharismaSimulation(OUTPUT_FILE)
        sim.display_charismata()
    else:
        print("[!] No data found. Check URL or HTML structure.")
